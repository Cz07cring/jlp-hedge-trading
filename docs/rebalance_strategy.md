# JLP 对冲再平衡策略方案

## 背景

对冲策略的核心权衡：**风险 vs 成本**

- 频繁调仓 → 低风险、高成本（手续费+滑点）
- 稀疏调仓 → 高风险、低成本

**中性套利的核心要求**：敞口越小越好，理想状态是 0 敞口。

---

## 敞口风险分析

### 敞口对收益的影响

假设本金 $15,000，对冲比例 70%（$10,500）：

| 敞口偏离 | 敞口金额 | BTC跌10%损失 | 占本金比例 |
|----------|----------|--------------|-----------|
| 1% | $105 | $10.5 | 0.07% |
| 2% | $210 | $21 | 0.14% |
| 3% | $315 | $31.5 | 0.21% |
| 5% | $525 | $52.5 | 0.35% |
| 10% | $1,050 | $105 | 0.70% |

**结论**：敞口控制在 1-2% 内，即使遇到 10% 波动，损失也可控。

---

## 推荐方案：紧凑型混合策略

针对中性套利优化，控制敞口在 **1-2%** 以内：

```
┌─────────────────────────────────────────────────────────┐
│              紧凑型再平衡策略（低敞口版）                  │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 高频检测（每 1 分钟）                                 │
│     └── 实时监控各资产偏离度                              │
│                                                         │
│  2. 常规触发（满足任一即调仓）                            │
│     ├── 单资产偏离 > 2%                                  │
│     ├── 总敞口偏离 > 1.5%                                │
│     └── 距上次调仓 > 1 小时 且 偏离 > 1%                  │
│                                                         │
│  3. 紧急触发（立即调仓 + 告警）                           │
│     ├── 单资产偏离 > 5%                                  │
│     └── 总敞口偏离 > 3%                                  │
│                                                         │
│  4. 调仓方式                                             │
│     ├── 优先使用 Maker 单（降低成本）                     │
│     └── 超过紧急阈值时用 Taker 单（快速成交）              │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 详细参数配置

### 1. 检测频率

```yaml
check_interval: 60  # 1分钟检测一次
```

**原因**：
- 中性套利需要更精确的对冲
- 1分钟检测可以及时发现偏离
- 检测成本几乎为零

### 2. 常规调仓阈值（紧凑版）

```yaml
rebalance_thresholds:
  # 单资产偏离阈值
  asset_threshold: 0.02      # 2%

  # 总敞口偏离阈值
  total_threshold: 0.015     # 1.5%

  # 时间+偏离组合阈值
  time_threshold_hours: 1    # 1小时
  time_threshold_delta: 0.01 # 1%
```

### 3. 紧急调仓阈值

```yaml
emergency_thresholds:
  asset_threshold: 0.05   # 单资产 5%
  total_threshold: 0.03   # 总敞口 3%
```

### 4. 最小调仓量（降低版）

```yaml
min_order_sizes:
  SOL: 0.05     # 约 $11.5
  ETH: 0.005    # 约 $18.5
  BTC: 0.0005   # 约 $48.5
```

### 5. 订单类型（已实现）

当前系统已使用 **Maker 单**，手续费更低：

| 订单类型 | 手续费 | 说明 |
|----------|--------|------|
| Maker | 0.02% | 当前使用 ✅ |
| Taker | 0.05% | 备用 |

---

## 调仓决策流程图

```
                    ┌─────────────┐
                    │  定时检测    │
                    │  (每1分钟)   │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │ 计算各资产   │
                    │ 偏离度       │
                    └──────┬──────┘
                           │
         ┌─────────────────┼─────────────────┐
         ▼                 ▼                 ▼
   ┌───────────┐    ┌───────────┐    ┌───────────┐
   │单资产>5%  │    │单资产>2%  │    │单资产<2%  │
   │或总>3%    │    │或总>1.5%  │    │且总<1.5%  │
   └─────┬─────┘    └─────┬─────┘    └─────┬─────┘
         │                │                │
         ▼                ▼                ▼
   ┌───────────┐    ┌───────────┐    ┌───────────┐
   │紧急调仓   │    │常规调仓   │    │检查时间   │
   │Taker+告警 │    │Maker优先  │    │>1h且>1%?  │
   └───────────┘    └───────────┘    └─────┬─────┘
                                           │
                              ┌────────────┴────────────┐
                              ▼                         ▼
                       ┌───────────┐            ┌───────────┐
                       │ 是：调仓   │            │ 否：跳过   │
                       └───────────┘            └───────────┘
```

---

## 成本估算（Maker 模式）

### 假设条件
- 本金: $15,000
- 对冲价值: $10,500
- Maker 手续费: **0.02%**（已实现）
- 平均调仓比例: 10%（每次调整 $1,050）

### 紧凑策略成本估算

| 场景 | 年调仓次数 | 平均调仓额 | 费率 | 年成本 | 成本率 |
|------|-----------|-----------|------|--------|--------|
| **全部 Maker** | 850 | $1,050 | 0.02% | **$178.5** | **1.19%** |

### 与宽松策略对比

| 策略 | 年调仓次数 | 年成本 | 最大敞口 | 平均敞口 |
|------|-----------|--------|----------|----------|
| 宽松(5%/3%) | 300 | $63 | 10% | 3% |
| **紧凑(2%/1.5%)** | 850 | **$178** | **5%** | **1.5%** |

**额外成本 $115/年（约 0.77%），换取敞口从 3% 降到 1.5%，值得！**

### 成本 vs 风险权衡

```
年成本
  $200 ┤         ┌─────── 紧凑策略
       │        ╱         敞口 1.5%
  $150 ┤       ╱
       │      ╱
  $100 ┤─────┘
       │  宽松策略
   $50 ┤  敞口 3%
       │
    $0 ┴─────────────────────→ 敞口控制精度
```

---

## 分资产阈值（高级版）

根据各资产波动性和权重，设置不同阈值：

```yaml
asset_specific_thresholds:
  SOL:
    weight: 0.45          # 权重最大，需要更严格
    normal_threshold: 0.015   # 1.5%
    emergency_threshold: 0.04 # 4%

  ETH:
    weight: 0.085
    normal_threshold: 0.025   # 2.5%（权重小，可以宽松点）
    emergency_threshold: 0.06 # 6%

  BTC:
    weight: 0.16
    normal_threshold: 0.02    # 2%
    emergency_threshold: 0.05 # 5%
```

**原因**：
- SOL 权重 45%，偏离影响最大，需要最严格
- ETH 权重仅 8.5%，可以稍微宽松
- BTC 波动相对小，阈值居中

---

## 实施方案

### Phase 1: 配置文件

```json
{
  "rebalance": {
    "check_interval_seconds": 60,
    "order_strategy": {
      "normal_type": "maker",
      "maker_timeout_seconds": 30,
      "emergency_type": "taker"
    },
    "thresholds": {
      "total_normal_pct": 1.5,
      "total_emergency_pct": 3.0,
      "time_hours": 1,
      "time_delta_pct": 1.0
    },
    "asset_thresholds": {
      "SOL": {"normal": 1.5, "emergency": 4.0},
      "ETH": {"normal": 2.5, "emergency": 6.0},
      "BTC": {"normal": 2.0, "emergency": 5.0}
    },
    "min_order_sizes": {
      "SOL": 0.05,
      "ETH": 0.005,
      "BTC": 0.0005
    }
  }
}
```

### Phase 2: 代码修改

1. `services/position_manager.py`
   - 添加分资产阈值支持
   - 添加总敞口计算

2. `main.py`
   - 修改检测间隔为 1 分钟
   - 添加时间+偏离组合判断
   - 添加紧急调仓逻辑

3. `services/risk_monitor.py`
   - 添加敞口监控和告警

### Phase 3: 监控告警

```yaml
alerts:
  - type: "emergency_rebalance"
    message: "紧急调仓触发: {asset} 偏离 {deviation}%"

  - type: "high_deviation_persist"
    condition: "偏离>2% 持续超过 10 分钟"
    message: "持续高偏离警告"

  - type: "rebalance_failed"
    message: "调仓失败: {reason}"
```

---

## 预期效果

### 紧凑策略指标

| 指标 | 目标值 |
|------|--------|
| 检测频率 | 1 分钟 |
| 平均敞口 | < 1.5% |
| 最大敞口 | < 5% |
| 年调仓次数 | 800-1000 次 |
| 年成本率 | **~1.2%**（Maker） |

### 敞口控制效果

```
偏离度
  5% ┤                          ← 紧急阈值
     │
  3% ┤    ╱╲      ╱╲            ← 原方案常规阈值
     │   ╱  ╲    ╱  ╲
  2% ┤──╱────╲──╱────╲────────  ← 新方案常规阈值
     │ ╱      ╲╱      ╲
  1% ┤╱                ╲
     │                  ╲╱╲╱╲
  0% ┴─────────────────────────→ 时间
```

---

## 总结

**紧凑策略 vs 宽松策略**：

| 对比项 | 宽松策略 | 紧凑策略 |
|--------|----------|----------|
| 常规阈值 | 5%/3% | **2%/1.5%** |
| 紧急阈值 | 10%/8% | **5%/3%** |
| 检测频率 | 5分钟 | **1分钟** |
| 平均敞口 | 3% | **1.5%** |
| 年成本(Maker) | $63 | **$178** |
| 年成本率 | 0.42% | **1.19%** |
| 风险等级 | 中 | **低** |

**推荐紧凑策略**：
- 额外成本 $115/年（0.77%）
- 敞口从 3% 降到 1.5%
- 对于中性套利策略，更精确的对冲是值得的
